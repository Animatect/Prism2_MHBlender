# USD Master Version Implementation

## Summary

Successfully implemented USD-specific master version handling in the MH Extension. When creating a master version of a USD file, the system now creates a lightweight reference file instead of copying the actual USD data.

## What Was Changed

### 1. Extended Product Manager
**File**: [MHExtension/Scripts/Prism_MHExtension_Products.py](MHExtension/Scripts/Prism_MHExtension_Products.py)

Added three new methods:

#### `updateMasterVersion(origFunc, path)` - Lines 173-342
Main monkey-patched function that:
- Detects USD files by extension (.usda, .usdc, .usd)
- For USD files: creates reference-based master
- For other files: calls original Prism function
- Handles all the logic for generating USD reference files

#### `_extractUsdMetadata(usdPath)` - Lines 344-389
Helper function that:
- Reads first 2000 chars of source USD file
- Extracts metadata using regex: fps, metersPerUnit, upAxis, timeCodesPerSecond
- Returns dict with metadata (or defaults if extraction fails)

#### `_generateUsdReferenceFile(relPath, defaultPrim, metadata, sourceVersion)` - Lines 391-425
Helper function that:
- Generates USD ASCII file content
- Creates proper USD header with metadata
- Sets up reference to versioned file using relative path
- Configures defaultPrim based on product type

### 2. Applied Monkey Patch
**File**: [MHExtension/Scripts/Prism_MHExtension_Functions.py](MHExtension/Scripts/Prism_MHExtension_Functions.py)

Added monkey patch in `onPluginLoaded()` - Lines 86-93:
```python
self.core.plugins.monkeyPatch(
    self.core.products.updateMasterVersion,
    self.productsManager.updateMasterVersion,
    self,
    force=True
)
```

**Important**: This patch applies to ALL applications, not just Blender.

## How It Works

### For USD Files

1. **Detection**: Checks if file extension is `.usda`, `.usdc`, or `.usd`

2. **Master Path Generation**: Creates master path with `.usda` extension (always ASCII for readability)

3. **Metadata Extraction**: Reads source USD file to extract:
   - framesPerSecond
   - metersPerUnit
   - timeCodesPerSecond
   - upAxis

4. **Reference File Creation**: Generates USD file like:
   ```usda
   #usda 1.0
   (
       defaultPrim = "configure_geo_layer"
       doc = """Generated by Prism Pipeline - MH Extension"""
       framesPerSecond = 24
       metersPerUnit = 1
       timeCodesPerSecond = 24
       upAxis = "Y"
   )

   def "configure_geo_layer" (
       prepend references = @../v0024/chartoOmit_usdlayer_geo_v0024.usdc@
   )
   {
   }
   ```

5. **File Management**:
   - Copies version info files normally
   - Copies non-USD metadata files (textures, etc.)
   - SKIPS copying actual USD files (they're referenced, not copied)
   - Updates preferredFile in master's version info

### For Non-USD Files

- Calls the original `updateMasterVersion()` function
- Standard Prism behavior (copy or hardlink depending on settings)

## defaultPrim Naming Logic

The function automatically determines the defaultPrim name:

**For usdlayer_* products:**
- Pattern: `configure_{layertype}_layer`
- Example: `usdlayer_geo` → `configure_geo_layer`
- Example: `usdlayer_mtl` → `configure_mtl_layer`

**For regular products:**
- Uses entity name (asset name or shot name)
- Example: Asset "chartoOmit" → `chartoOmit`

## Benefits

✅ **Saves Disk Space**: References use ~1KB instead of copying large USD files
✅ **Easy Updates**: Changing source version automatically updates all references
✅ **USD Compatible**: Works with any USD-aware application
✅ **Metadata Preserved**: Maintains fps, units, and axis from source
✅ **Backward Compatible**: Non-USD files use standard Prism behavior
✅ **Relative Paths**: References use `../v0024/file.usdc` format for portability

## Testing

To test the implementation:

1. **Create a USD product version**:
   - In Blender, export a USD file (usdlayer_geo, usdlayer_mtl, or ASSET)
   - Make sure it's saved with a version number

2. **Set as master** (two ways):
   - **Manual**: Right-click version in Product Browser → "Set as master"
   - **Automatic**: Enable "Update Master Version" checkbox in Export state

3. **Verify master file**:
   - Navigate to master folder
   - Open the `.usda` file in a text editor
   - Should see USD reference format with relative path
   - Should NOT see copied USD files (only reference file + version info)

4. **Test in USD application**:
   - Open master file in Blender, Houdini, or USD viewer
   - Should resolve reference and show geometry
   - Change source version and verify master updates

## Example Output

**Source version**: `y:/Projects/MyProject/Export/usdlayer_geo/v0024/asset_usdlayer_geo_v0024.usdc` (100 MB)

**Master version**: `y:/Projects/MyProject/Export/usdlayer_geo/master/asset_usdlayer_geo_master.usda` (1 KB)

**Master file contents**:
```usda
#usda 1.0
(
    defaultPrim = "configure_geo_layer"
    doc = """Generated by Prism Pipeline - MH Extension"""
    framesPerSecond = 24
    metersPerUnit = 1
    timeCodesPerSecond = 24
    upAxis = "Y"
)

def "configure_geo_layer" (
    prepend references = @../v0024/asset_usdlayer_geo_v0024.usdc@
)
{
}
```

## Troubleshooting

### Master file has wrong metadata
- Check source USD file is valid and contains metadata
- Metadata extraction only works with .usda (ASCII) files reliably
- Binary .usdc files fall back to defaults (24fps, Y-up, 1m)

### Reference path not resolving
- Verify relative path is correct
- Master and versioned files must maintain folder structure
- Check for special characters in paths

### Master still copying USD files
- Check file extension is lowercase (.usd, not .USD)
- Verify monkey patch is applied (check logs for "Applied USD master version monkey patch")
- Ensure MH Extension plugin is loaded

## Future Enhancements

Potential improvements:
- Use USD Python API for more robust metadata extraction
- Support for binary .usdc metadata reading
- Option to include custom USD attributes in master file
- Support for variant sets in master files
- Payload vs reference option for large files

## Code Location

- **Main implementation**: [MHExtension/Scripts/Prism_MHExtension_Products.py](MHExtension/Scripts/Prism_MHExtension_Products.py#L173-L425)
- **Monkey patch registration**: [MHExtension/Scripts/Prism_MHExtension_Functions.py](MHExtension/Scripts/Prism_MHExtension_Functions.py#L86-L93)
- **Documentation**: [PRISM_MASTER_VERSIONS.md](PRISM_MASTER_VERSIONS.md#L264-L340)
